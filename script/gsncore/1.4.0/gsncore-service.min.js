/*!
gsn.core - 1.4.0
GSN API SDK
Build date: 2015-02-02 04-59-53 
*/
(function(){"use strict";function a(){var a=n.userAgent,b=a.indexOf("MSIE "),c=a.indexOf("Trident/");if(b>0)return parseInt(a.substring(b+5,a.indexOf(".",b)),10);if(c>0){var d=a.indexOf("rv:");return parseInt(a.substring(d+3,a.indexOf(".",d)),10)}return!1}function b(a,b){function c(){(void 0===this.readyState||"complete"===this.readyState)&&"function"==typeof b&&b()}var d=document.createElement("script");d.type="text/javascript",d.src=a,b&&(d.onload=c,d.onreadystatechange=c),document.body.appendChild(d)}var c=this,d=(c.gsn,{}),e=Array.prototype,f=Object.prototype,g=e.slice,h=f.hasOwnProperty,i=e.forEach,j=e.map,k=e.some,l=e.indexOf,m=Object.keys,n=function(a){return a instanceof n?a:this instanceof n?(this._wrapped=a,this):new n(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=n),exports.gsn=n):c.gsn=n,n.VERSION="1.0.3",n.config={AuthServiceUrl:"/proxy/auth",StoreServiceUrl:"/proxy/store",ProfileServiceUrl:"/proxy/profile",ShoppingListServiceUrl:"/proxy/shoppinglist",LoggingServiceUrl:"/proxy/logging",YoutechCouponUrl:"/proxy/couponut",RoundyProfileUrl:"/proxy/roundy",MidaxServiceUrl:"/proxy/midax",ApiUrl:"",Version:(new Date).getTime(),EmailRegex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,ServiceUnavailableMessage:"We are unable to process your request at this time.",UseLocalStorage:!1,ContentBaseUrl:"/app",MaxResultCount:50,ChainId:0,ChainName:"Grocery Shopping Network",DfpNetworkId:"/6394/digitalstore.test",GoogleAnalyticAccountId1:null,GoogleAnalyticAccountId2:null,GoogleSiteVerificationId:null,RegistrationFromEmailAddress:"tech@grocerywebsites.com",EnableCircPlus:null,EnableShopperWelcome:null,FacebookAppId:null,FacebookPermission:null,GoogleSiteSearchCode:null,DisableLimitedTimeCoupons:!1,hasRoundyProfile:!1,Theme:null,HomePage:null},n.identity=function(a){return a},n.userAgent=c.navigator.userAgent,n.browser={isIE:a(),userAgent:n.userAgent,isMobile:/iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dolphin|Skyfire|Zune/gi.test(n.userAgent),isAndroid:/(android)/gi.test(n.userAgent),isIOS:/iP(hone|od|ad)/gi.test(n.userAgent)};var o=n.each=n.forEach=function(a,b,c){if(null!==n.isNull(a,null))if(i&&a.forEach===i)a.forEach(b,c);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(c,a[e],e,a)===d)return}else for(var g=n.keys(a),h=0,j=g.length;j>h;h++)if(b.call(c,a[g[h]],g[h],a)===d)return};n.map=n.collect=function(a,b,c){var d=[];return null===n.isNull(a,null)?d:j&&a.map===j?a.map(b,c):(o(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},n.extend=function(a){return o(g.call(arguments,1),function(b){"undefined"!=typeof b&&n.forEach(b,function(b,c){null!==n.isNull(b,null)&&(a[c]=b)})}),a};var p=n.some=n.any=function(a,b,c){b=b||n.identity;var e=!1;return null===n.isNull(a,null)?e:k&&a.some===k?a.some(b,c):(o(a,function(a,f,g){return e||(e=b.call(c,a,f,g))?d:null}),!!e)};n.contains=n.include=function(a,b){return null===n.isNull(a,null)?!1:l&&a.indexOf===l?-1!=a.indexOf(b):p(a,function(a){return a===b})},n.applyConfig=function(a,b){n.extend(n.config,a),n.config.HomePage=n.parsePartialContentData(n.config.HomePage);var c=!b;if(c&&n.browser.isAndroid){var d=n.browser.userAgent,e=parseFloat(d.slice(d.indexOf("Android")+8));if(e>4)return;c=!1}c||n.forEach(n.config,function(a,b){"string"==typeof a&&"ApiUrl"!=a&&a.indexOf("/proxy/")>=0&&(n.config[b]=a.replace("/proxy/",n.config.ApiUrl+"/"))})},n.isNull=function(a,b){return"undefined"==typeof a||null===a?b:a},n.isNaN=function(a,b){return isNaN(a)?b:a},n.sortOn=function(a,b){return null===n.isNull(a,null)?null:a.length<=0?[]:(a.sort("string"==typeof a[0][b]?function(a,c){return(a[b]&&a[b].toLowerCase())<(c[b]&&c[b].toLowerCase())?-1:(a[b]&&a[b].toLowerCase())>(c[b]&&c[b].toLowerCase())?1:0}:function(a,c){return a[b]<c[b]?-1:a[b]>c[b]?1:0}),a)},n.cleanKeyword=function(a){var b=a.replace(/[^a-zA-Z0-9]+/gi,"_").replace(/^[_]+/gi,"");return null!==n.isNull(b.toLowerCase,null)&&(b=b.toLowerCase()),b},n.groupBy=function(a,b,c){if(null===n.isNull(a,null))return[];var d=[],e={};n.forEach(a,function(a){var c=a[b],d=e[c];null===n.isNull(d,null)&&(d={key:c,items:[]},e[c]=d),d.items.push(a)});var f=0;return n.forEach(e,function(a){a.$idx=f++,d.push(a),c&&c(a)}),n.sortOn(d,"key")},n.mapObject=function(a,b){var c={};return a&&(n.isNull(a.length,-1)<0?c[a[b]]=a:n.map(a,function(a){c[a[b]]=a})),c},n.keys=m||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)n.has(a,c)&&b.push(c);return b},n.has=function(a,b){return h.call(a,b)},n.getUrl=function(a,b){b=n.isNull(b,"");var c=(b.indexOf("?")>0?"&":"?")+"nocache="+n.config.Version;return(a+b+c).replace(/(\\\\)+/gi,"\\")},n.getContentUrl=function(a){return n.getUrl(n.config.ContentBaseUrl,a)},n.getThemeUrl=function(a){var b=n.config.ContentBaseUrl;return n.isNull(n.config.SiteTheme,"").length>0&&(b=b.replace("/"+n.config.ChainId,"/"+n.config.SiteTheme)),n.getUrl(b,a)},n.setTheme=function(a){n.config.SiteTheme=a},c.globalConfig&&(n.config.ApiUrl=n.isNull(c.globalConfig.apiUrl,"").replace(/\/+$/g,"")),n.loadScripts=function(a,c){function d(){if(e.length<=0)"function"==typeof c&&c();else{var a=e[0];e.splice(0,1),b(a,d)}}if(n.isNull(a.length,0)<=0)"function"==typeof c&&c();else{var e=[].concat(a);d()}},n.loadIframe=function(a,b){var c=document.createElement("iframe");if(a[0].appendChild(c),c.contentWindow)c.contentWindow.contents=b,c.src='javascript:window["contents"]';else{var d=c.document;c.contentDocument&&(d=c.contentDocument),d.open(),d.write(b),d.close()}return c},n.parsePartialContentData=function(a){null===n.isNull(a,null)&&(a={ConfigData:{},ContentData:{},ContentList:[]});var b=a;if(b.ConfigData)return b;var c=[],d=[];if(b.Contents){n.forEach(b.Contents,function(a){a.IsMetaData?c.push(a):d.push(a)}),b.Contents=null,b.ConfigData=n.mapObject(c,"Headline"),b.ContentData=n.mapObject(d,"SortBy");for(var e=[],f=0;f<d.length;f++)e.push(d[f]);e.length>0&&(b.ContentList=n.sortOn(e,"SortBy"))}return b}}).call(this),function(a,b,c){"use strict";c.module("angulartics.gsn.ga",["angulartics"]).config(["$analyticsProvider",function(c){c.init=function(){c.settings&&(c.settings.trackRelativePath=!0);var d=b.isNull(b.config.GoogleAnalyticAccountId1,"").length>0,e=b.isNull(b.config.GoogleAnalyticAccountId2,"").length>0;a.ga&&(d?(ga("create",b.config.GoogleAnalyticAccountId1,"auto"),e&&ga("create",b.config.GoogleAnalyticAccountId2,"auto",{name:"trackerTwo"})):e&&(e=!1,ga("create",b.config.GoogleAnalyticAccountId2,"auto")),ga("require","displayfeatures")),c.registerPageTrack(function(b){a.ga&&(ga("send","pageview",b),e&&ga("trackerTwo.send","pageview",b)),a._paq&&(_paq.push(["setCustomUrl",b]),_paq.push(["trackPageView"])),a._qevents&&_qevents.push({qacct:"p-1bL6rByav5EUo"})}),c.registerEventTrack(function(b,c){if(c.value){var d=parseInt(c.value,10);c.value=isNaN(d)?0:d}if(a.ga&&(c.noninteraction?(ga("send","event",c.category,b,c.label,c.value,{nonInteraction:1}),e&&ga("trackerTwo.send","event",c.category,b,c.label,c.value,{nonInteraction:1})):(ga("send","event",c.category,b,c.label,c.value),e&&ga("trackerTwo.send","event",c.category,b,c.label,c.value))),a.Piwik){var f=Piwik.getAsyncTracker();f.trackEvent(c.category,b,c.label,c.value)}})}}])}(window,gsn,angular),function(a,b){"use strict";function c(c,d,e,f,g,h,i,j,k){function l(){var a=m(),b=r.isNull(a.expires_dt,0)>0&&a.expires_dt>(new Date).getTime();if(b)return null;var c={grant_type:"anonymous",client_id:r.getChainId(),access_type:"offline"};return"undefined"!=typeof a.refresh_token&&(c.grant_type="refresh_token",c.refresh_token=a.refresh_token),c}function m(){return r.isNull(s.accessToken,{})}function n(a){if(s.accessToken=a||{},a){var b=parseInt(r.isNull(a.user_id,0));r.isNaN(b,0)>0&&c.$broadcast("gsnevent:profile-setid",b),"anonymous"==a.grant_type&&p(a)}}function o(){return r.isNull(i.anonymousToken,{})}function p(a){var b=r.isNull(a,{});i.anonymousToken=b}function q(){}var r={previousDefer:null},s=i;return r.isNull=a.isNull,r.isNaN=a.isNaN,r.sortOn=a.sortOn,r.groupBy=a.groupBy,r.mapObject=a.mapObject,r.forEach=a.forEach,r.extend=a.extend,r.getContentUrl=function(b){return j.trustAsResourceUrl(a.getContentUrl(b))},r.getThemeUrl=function(b){return j.trustAsResourceUrl(a.getThemeUrl(b))},r.cleanKeyword=a.cleanKeyword,r.loadIframe=a.loadIframe,r.loadScripts=a.loadScripts,r.userAgent=a.userAgent,r.browser=a.browser,r.parsePartialContentData=a.parsePartialContentData,r.getConfig=function(){return a.config},r.getApiUrl=function(){return a.config.ApiUrl},r.getStoreUrl=function(){return a.config.StoreServiceUrl},r.getContentServiceUrl=function(a){return r.getApiUrl()+"/Content/"+a+"/"+r.getChainId()+"/"+r.isNull(r.getSelectedStoreId(),"0")+"/"},r.getYoutechCouponUrl=function(){return a.config.YoutechCouponUrl},r.getRoundyProfileUrl=function(){return a.config.RoundyProfileUrl},r.getProductServiceUrl=function(){return a.config.ProductServiceUrl},r.getShoppingListApiUrl=function(){return a.config.ShoppingListServiceUrl},r.getProfileApiUrl=function(){return a.config.ProfileServiceUrl},r.getLoggingApiUrl=function(){return a.config.LoggingServiceUrl},r.getMidaxServiceUrl=function(){return a.config.MidaxServiceUrl},r.getUseLocalStorage=function(){return r.isNull(a.config.UseLocalStorage,!1)},r.getVersion=function(){return a.config.Version},r.getGoogleSiteSearchCode=function(){return a.config.GoogleSiteSearchCode},r.getGoogleSiteVerificationId=function(){return a.config.GoogleSiteVerificationId},r.getEnableCircPlus=function(){return"true"==r.isNull(a.config.EnableCircPlus,"false")},r.getEnableShopperWelcome=function(){return"true"==r.isNull(a.config.EnableShopperWelcome,"false")},r.isBetween=function(a,b,c){return a>b&&c>a},r.getFacebookPermission=function(){return r.isNull(a.config.FacebookPermission,"email")},r.getGoogleAnalyticAccountId1=function(){return r.isNull(a.config.GoogleAnalyticAccountId1,"")},r.getGoogleAnalyticAccountId2=function(){return r.isNull(a.config.GoogleAnalyticAccountId2,"")},r.getEmailRegEx=function(){return a.config.EmailRegex},r.getDfpNetworkId=function(){return a.config.DfpNetworkId},r.getMaxResultCount=function(){return a.config.MaxResultCount?a.config.MaxResultCount:50},r.getServiceUnavailableMessage=function(){return a.config.ServiceUnavailableMessage},r.getChainId=function(){return a.config.ChainId},r.getChainName=function(){return a.config.ChainName},r.getHomeData=function(){return a.config.HomePage},r.getRegistrationFromEmailAddress=function(){return a.config.RegistrationFromEmailAddress},r.htmlFind=function(a,c){return b.element("<div>"+a+"</div>").find(c).length},r.equalsIgnoreCase=function(a,c){return b.lowercase(a)==b.lowercase(c)},r.toLowerCase=function(a){return b.lowercase(a)},r.goUrl=function(a,c){try{b.element(".modal").modal("hide")}catch(e){}return"_blank"==r.isNull(c,"")?void d.open(a,""):"_reload"==r.isNull(c,"")?void(d.top?d.top.location=a:d.location=a):void h.url(a)},r.parseStoreSpecificContent=function(a){var c={},d=a,e=r.isNull(r.getSelectedStoreId(),0);a&&a.Id&&(d=[a]);var f=0;return b.forEach(d,function(a){var d=r.isNull(a.StoreIds,[]);0>=f&&d.length<=0&&(c=a),f++,0>=e||b.forEach(d,function(b){e==b&&(c=a)})}),c},r.getThemeContent=function(a){return r.parseStoreSpecificContent(r.getHomeData().ContentData[a])},r.getThemeConfig=function(a){return r.parseStoreSpecificContent(r.getHomeData().ConfigData[a])},r.getThemeConfigDescription=function(a,b){var c=r.getThemeConfig(a).Description;return r.isNull(c,b)},r.getFullPath=function(a,b){var c=(r.isNull(a,"")+"").replace(/$\/+/gi,"");return c.indexOf("http")>-1?a:("localhost"==h.host()&&(b=!0),c=h.protocol()+"://"+h.host()+(b?":"+h.port():"")+("/"+c).replace(/(\/\/)+/gi,"/"))},r.getPageCount=function(a,b){return a=a||[],Math.ceil(a.length/b)||1},r.getSelectedStoreId=function(){return s.storeId},r.setSelectedStoreId=function(a){var b=parseInt(a);r.isNaN(b,0)<=0&&(a=null);var d=s.storeId;s.storeId=a,c.$broadcast("gsnevent:store-setid",{newValue:a,oldValue:d})},r.getProfileId=function(){var a=m();return r.isNaN(parseInt(r.isNull(a.user_id,0)),0)},r.getShoppingListId=function(){return r.isNull(s.shoppingListId,0)},r.setShoppingListId=function(a,b){s.shoppingListId=r.isNull(a,0),b||c.$broadcast("gsnevent:shoppinglist-setid",a)},r.waitUntil=function(a,b){function c(){(g||a())&&d.resolve({success:!g}),e(c,200)}var d=f.defer(),g=!1;return e(function(){g=!0},b||2e3),c(),d.promise},r.getApiHeaders=function(){var a=m(),b={site_id:r.getChainId(),store_id:r.getSelectedStoreId(),profile_id:r.getProfileId(),access_token:a.access_token,"Content-Type":"application/json"};return b},r.isAnonymous=function(){var a=m();return"anonymous"==r.isNull(a.grant_type,"")},r.isLoggedIn=function(){var a=m();return"password"==r.isNull(a.grant_type,"")},r.logOut=function(){var a=r.getProfileId(),b=o();n(b),r.isNull(b.expires_dt,0)<=0&&r.getAccessToken(),c.$broadcast("gsnevent:logout",{ProfileId:a})},r.doAuthenticate=function(b){g.post(a.config.AuthServiceUrl+"/Token2",b,{headers:{"Content-Type":"application/json",shopping_list_id:r.getShoppingListId()}}).success(function(a){a.expires_dt=(new Date).getTime()+1e3*a.expires_in,n(a);var d=r.previousDefer;d&&(r.previousDefer=null,d.resolve(a)),c.$broadcast("gsnevent:login-success",{success:!0,payload:b,response:a})}).error(function(a){var d="refresh_token"==b.grant_type&&r.isNull(a.ExceptionMessage,"").indexOf("expired")>0;d||c.$broadcast("gsnevent:login-failed",{success:!0,payload:b,response:a})})},r.setAccessToken=n,r.getAccessToken=function(){var a=null===r.isNull(r.previousDefer,null)?f.defer():r.previousDefer,b=l();return null===r.isNull(b,null)?(r.previousDefer=null,e(function(){a.resolve({success:!0,response:m()})},10),a.promise):null!==r.isNull(r.previousDefer,null)?r.previousDefer.promise:(r.previousDefer=a,r.doAuthenticate(b),a.promise)},r.httpGetOrPostWithCache=function(a,b,c){if(a.response)e(function(){a.deferred.resolve(a.response)},50);else if(null===r.isNull(a.deferred,null)){a.deferred=f.defer();var d=function(b){a.response={success:!0,response:b},a.deferred.resolve(a.response)},h=function(b){a.response={success:!1,response:b},a.deferred.resolve(a.response)};b.indexOf("/undefined")>0?h("Client error: invalid request."):r.getAccessToken().then(function(){a.url=b,c?g.post(b,c,{headers:r.getApiHeaders()}).success(d).error(h):g.get(b,{headers:r.getApiHeaders()}).success(d).error(h)})}return a.deferred.promise},r.isValidCaptcha=function(b,c){var d=f.defer();return g.post(a.config.AuthServiceUrl+"/ValidateCaptcha",{challenge:b,response:c},{headers:{"Content-Type":"application/json"}}).success(function(a){d.resolve("true"==a)}).error(function(){d.resolve(!1)}),d.promise},r.goBack=function(){e(function(){d.history.back()},10)},r.initApp=function(){c.appState="initializing",q(),c.getContentUrl=r.getContentUrl,c.getThemeUrl=r.getThemeUrl,c.getContentServiceUrl=r.getContentServiceUrl,c.gsnApi=r;var b=r.getHomeData().ConfigData;if(b){var d=b.layout;d&&(c.defaultLayout=a.getThemeUrl("/views/layout"+d.Description+"/layout.html"))}var f=m(),g=r.isNull(f.expires_dt,0)>0&&f.expires_dt>(new Date).getTime();if(!g){var h=o();n(h)}e(function(){c.appState="ready"},200)},c.$on("gsnevent:auth-expired",function(){var a=m();a.access_token&&(a.expires_dt=0,n(a)),r.getAccessToken()}),c.$on("gsnevent:auth-invalidrefresh",function(){var a=m();"anonymous"==a.grant_type&&p(),r.logOut(),k.reload()}),r}b.module("facebook",[]);var d="gsnApi";b.module("gsn.core",["ngRoute","ngSanitize","facebook"]).service(d,["$rootScope","$window","$timeout","$q","$http","$location","$localStorage","$sce","$route",c])}(gsn,angular),function(a){"use strict";function b(b,c,d,e,f){var g={},h=f.Gsn;return h.Advertising.on("clickRecipe",function(a){b(function(){c.url("/recipe?id="+a.detail.RecipeId)})}),h.Advertising.on("clickProduct",function(a){"gsnevent:clickProduct"==a.type&&b(function(){var b=a.detail;if(b){var c={Quantity:e.isNaN(parseInt(b.Quantity),1),ItemTypeId:7,Description:e.isNull(b.Description,"").replace(/^\s+/gi,""),CategoryId:b.CategoryId,BrandName:b.BrandName,AdCode:b.AdCode};d.addItem(c)}})}),h.Advertising.on("clickLink",function(d){"gsnevent:clickLink"==d.type&&b(function(){var b=d.detail;if(b){var g=e.isNull(b.Url,""),h=a.lowercase(g),i=e.isNull(b.Target,"");h.indexOf("recipecenter")>0&&(g="/recipecenter"),"_blank"==i?f.open(g,""):c.url(g)}})}),h.Advertising.on("clickBrickOffer",function(a){"gsnevent:clickBrickOffer"==a.type&&b(function(){var b=a.detail;if(b){var c=e.getProfileApiUrl()+"/BrickOffer/"+e.getProfileId()+"/"+b.OfferCode;f.open(c,"")}})}),g}var c="gsnAdvertising";a.module("gsn.core").service(c,["$timeout","$location","gsnProfile","gsnApi","$window",b])}(angular),function(a){"use strict";function b(b,c,d,e,f,g,h,i){function j(){s.isIE&&(s.delayBetweenLoad=15)}function k(){if(a.element(".gsnunit").length<=0)return!1;if(s.shopperWelcomeInProgress)return!1;var b=(new Date).getTime(),d=(b-c.isNull(s.lastRefreshTime,0))/1e3;return d>s.delayBetweenLoad}function l(){d.getStore().then(function(a){if(s.store!=a){var b=c.getDfpNetworkId().replace(/\/$/gi,"");if(s.store=a,s.store)try{b+="/"+s.store.City+"-"+s.store.StateName+"-"+s.store.PostalCode+"-"+s.store.StoreId,b=b.replace(/(undefined)+/gi,"").replace(/\s+/gi,"")}catch(d){b=c.getDfpNetworkId().replace(/\/$/gi,"")}s.dfpNetworkId!=b&&(s.dfpNetworkId=b,s.refreshExistingRegular=!1,s.refreshExistingCircPlus=!1)}})}function m(a,b){return parseFloat(c.isNull(f.GsnCampaign,0))<=0?void o():(setTimeout(p,b||50),void(s.enableCircPlus&&a&&setTimeout(q,b||500)))}function n(a,b){k()&&(s.lastRefreshTime=(new Date).getTime(),l(),c.isNull(s.dfpNetworkId,"").length<4&&(s.dfpNetworkId=c.getDfpNetworkId().replace(/\/$/gi,"")),s.shopperWelcomeInProgress=!0,$.gsnSw2({chainId:c.getChainId(),dfpID:s.dfpNetworkId,displayWhenExists:".gsnadunit,.gsnunit",enableSingleRequest:!1,apiUrl:c.getApiUrl()+"/ShopperWelcome/GetShopperWelcome/",onClose:function(){s.hasDisplayedShopperWelcome=!0,s.shopperWelcomeInProgress=!1,s.targeting.brand=Gsn.Advertising.getBrand(),s.targeting.brand||delete s.targeting.brand,m(a,b)}}))}function o(){f.GsnCampaign=c.getProfileId(),e.getCampaign().then(function(b){b.success&&(s.targeting.dept.length=0,a.forEach(b.response,function(a){s.targeting.dept.push(a.Value)})),s.lastRefreshTime=null,n()})}function p(){var b=a.copy(s.targeting),d=("/"+c.isNull(s.currentPath,"")).replace(/\/+$/gi,"").substr(s.currentPath.lastIndexOf("/"));b.dept=c.isNull(b.dept,[]),b.kw=d.replace(/[^a-z]/gi,""),a.element.gsnDfp({dfpID:s.dfpNetworkId,setTargeting:b,inViewOnly:!0,enableSingleRequest:!1,refreshExisting:s.refreshExistingRegular}),s.refreshExistingRegular=!0}function q(){if(s.enableCircPlus){var b=c.isNull(s.targeting.dept,[]);b.length<=0&&(b=["produce"]),a.element.circPlus({dfpID:s.dfpNetworkId,inViewOnly:!0,setTargeting:{dept:b[0]},refreshExisting:s.refreshExistingCircPlus,bodyTemplate:s.circPlusBody}),s.refreshExistingCircPlus=!0}}function r(b){var e=[],f=d.getCategories(),g={};return a.forEach(b,function(a){if(null!==c.isNull(a.CategoryId,null)&&f[a.CategoryId]){var b=c.cleanKeyword(f[a.CategoryId].CategoryName);if(g.hasOwnProperty(b))return;e.push(b),g[b]=1}}),e}var s={doRefresh:n,lastRefreshTime:null,targeting:{dept:[]},isLoading:!1,refreshExisting:!0,refreshExistingCircPlus:!0,dfpNetworkId:"",enableCircPlus:c.getEnableCircPlus(),enableShopperWelcome:c.getEnableShopperWelcome(),isIE:c.browser.isIE,hasDisplayedShopperWelcome:!1,shopperWelcomeInProgress:!1,circPlusBody:c.getChainId()<214||c.getChainId()>218?null:'<div class="gsn-slot-container"><div class="cpslot cpslot2" data-companion="true" data-dimensions="300x50"></div></div><div class="gsn-slot-container"><div class="cpslot cpslot1" data-companion="true" data-dimensions="300x100,300x120"></div></div>',delayBetweenLoad:5};return b.$on("gsnevent:shoppinglistitem-updating",function(a,b){var d=c.getShoppingListId();if(b.ShoppingListId==d){var f=e.getShoppingList().allItems().slice(0,10);s.targeting.dept=r(f),s.doRefresh(!0)}}),b.$on("$routeChangeSuccess",function(){s.lastRefreshTime=0,s.currentPath=a.lowercase(c.isNull(i.path(),""))}),b.$on("gsnevent:loadads",function(){s.refreshExistingRegular=!1,s.refreshExistingCircPlus=!1,h(function(){k()&&s.doRefresh()},0)}),b.$on("gsnevent:digitalcircular-pagechanging",function(){s.doRefresh(),a.element(g).scrollTop()>140&&g.scrollTo(0,120)}),j(),s}var c="gsnDfp";a.module("gsn.core").service(c,["$rootScope","gsnApi","gsnStore","gsnProfile","$sessionStorage","$window","$timeout","$location",b])}(angular),function(a){"use strict";function b(b,c,d,e){function f(f,g){function h(a,b){if(a){var c=j.getItemKey(b);delete k.items[c],a.Order=b.Order,k.items[j.getItemKey(a)]=a,k.countCache=0}}function i(c){k.items={},a.forEach(c,function(a,b){a.Order=b,k.items[j.getItemKey(a)]=a}),k.hasLoaded=!0,j.itemIdentity=c.length+1,b.$broadcast("gsnevent:shoppinglist-loaded",j,c)}var j={ShoppingListId:f,itemIdentity:1},k={list:g,items:{},hasLoaded:!1,countCache:0};return j.getItemKey=function(a){var b=a.ItemTypeId;return(7==a.ItemTypeId||a.AdCode)&&(b=a.AdCode+d.isNull(a.BrandName,"")+d.isNull(a.Description,"")),b+"_"+a.ItemId},j.syncItem=function(e){var f=j.getItem(e.ItemId,e.ItemTypeId)||e;if(f!=e&&(f.Quantity=e.Quantity),parseInt(f.Quantity)>0){var g=a.copy(f);delete g.BarcodeImageUrl,delete g.BottomTagLine,delete g.Description1,delete g.Description2,delete g.Description3,delete g.Description4,delete g.EndDate,delete g.ImageUrl,delete g.SmallImageUrl,delete g.StartDate,delete g.TopTagLine,delete g.TotalDownloads,delete g.TotalDownloadsAllowed,delete g.Varieties,b.$broadcast("gsnevent:shoppinglistitem-updating",j,f,k),d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/UpdateItem/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,g,{headers:e}).success(function(a){a.Id&&h(a,f),b.$broadcast("gsnevent:shoppinglist-changed",j)}).error(function(){f.OldQuantity&&(f.NewQuantity=f.OldQuantity,f.Quantity=f.OldQuantity)})})}else j.removeItem(f);b.$broadcast("gsnevent:shoppinglist-changed",j)},j.addItem=function(a,b){d.isNull(a.ItemId,0)<=0&&(a.ItemId=j.itemIdentity++),k.countCache=0;var c=k.items[j.getItemKey(a)];if(null===gsn.isNull(c,null))delete a.Id,delete a.ShoppingListItemId,a.ShoppingListId=j.ShoppingListId,c=a,k.items[j.getItemKey(c)]=c;else{var e=d.isNaN(parseInt(a.Quantity),1),f=d.isNaN(parseInt(c.Quantity),1);c.Quantity=e>f?e:f+e}if(c.IsCoupon){var g=d.isNaN(parseInt(c.Quantity),0);c.Quantity=g>0?g:1}return c.Order=j.itemIdentity++,d.isNull(b,!1)||j.syncItem(c),c},j.addItems=function(f){var g=e.defer(),h=[];return a.forEach(f,function(b){var c=a.copy(j.addItem(b,!0));h.push(c)}),b.$broadcast("gsnevent:shoppinglistitems-updating",j),k.countCache=0,d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/SaveItems/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,h,{headers:e}).success(function(a){b.$broadcast("gsnevent:shoppinglist-changed",j),g.resolve({success:!0,response:a})}).error(function(){g.resolve({success:!1,response:response})})}),g.promise},j.removeItem=function(a,e){var f=j.getItem(a);if(f){if(f.Quantity=0,delete k.items[j.getItemKey(f)],e)return j;k.countCache=0,d.getAccessToken().then(function(){b.$broadcast("gsnevent:shoppinglist-item-removing",j,f);var a=d.getShoppingListApiUrl()+"/DeleteItems/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,[f.Id||f.ItemId],{headers:e}).success(function(){b.$broadcast("gsnevent:shoppinglist-changed",j)})})}return j},j.removeItems=function(f){var g=e.defer(),h=[];return k.countCache=0,a.forEach(f,function(a){var b=j.getItemKey(item),c=j.getItem(b);c&&(h.push(a.Id),item.Quantity=0,delete k.items[b])}),d.getAccessToken().then(function(){b.$broadcast("gsnevent:shoppinglist-items-removing",j,item);var a=d.getShoppingListApiUrl()+"/DeleteItems/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,h,{headers:e}).success(function(a){b.$broadcast("gsnevent:shoppinglist-changed",j),g.resolve({success:!0,response:a})}).error(function(a){g.resolve({success:!1,response:a})})}),g.promise},j.getItem=function(a,b){var c,e,f;"object"==typeof a&&(c=a.AdCode,e=a.BrandName,f=a.Description,b=a.ItemTypeId,a=a.ItemId);var g=j.getItemKey({ItemId:a,ItemTypeId:d.isNull(b,8),AdCode:c,BrandName:e,Description:f});return k.items[g]},j.isValidItem=function(a){var b=typeof a;return"undefined"!==b&&"function"!==b?a.Quantity>0:!1},j.allItems=function(){var b=[],c=k.items;return a.forEach(c,function(a){j.isValidItem(a)&&b.push(a)}),b},j.getCount=function(){if(k.countCache>0)return k.countCache;var b=0,c=k.items;return a.forEach(c,function(a){j.isValidItem(a)&&(b+=d.isNaN(parseInt(a.Quantity),0))}),k.countCache=b,b},j.clearItems=function(){k.items={},k.countCache=0,j.saveChanges()},j.getTitle=function(){return k.list?k.list.Title:""},j.getStatus=function(){return k.list?k.list.StatusId:1},j.deleteList=function(){return k.countCache=0,d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/Delete/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,{},{headers:e}).success(function(){b.$broadcast("gsnevent:shoppinglist-deleted",j)})}),j},j.saveChanges=function(){if(j.savingDeferred)return j.savingDeferred.promise;var f=e.defer();j.savingDeferred=f,k.countCache=0;var g=[],h=j.allItems();return a.forEach(h,function(a){g.push(a.ItemId)}),d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/DeleteOtherItems/"+j.ShoppingListId,e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.post(a,g,{headers:e}).success(function(){f.resolve({success:!0,response:j}),j.savingDeferred=null,b.$broadcast("gsnevent:shoppinglist-changed",j)}).error(function(a){f.resolve({success:!1,response:a}),j.savingDeferred=null})}),f.promise},j.setTitle=function(a){var f=e.defer();return k.countCache=0,d.getAccessToken().then(function(){var e=d.getShoppingListApiUrl()+"/Update/"+j.ShoppingListId+"?title="+encodeURIComponent(a),g=d.getApiHeaders();g.shopping_list_id=j.ShoppingListId,c.post(e,{},{headers:g}).success(function(){f.resolve({success:!0,response:j}),k.list.Title=a,b.$broadcast("gsnevent:shopping-list-saved"),b.$broadcast("gsnevent:shoppinglist-changed",j)}).error(function(a){console.log(j.ShoppingListId+" setTitle error: "+a),f.resolve({success:!1,response:a})})}),f.promise},j.hasLoaded=function(){return k.hasLoaded},j.getListData=function(){return a.copy(k.list)},j.updateShoppingList=function(a){if(j.deferred)return j.deferred.promise;var f=e.defer();return j.deferred=f,k.items={},k.countCache=0,j.ShoppingListId>0&&(a?(i(a),b.$broadcast("gsnevent:shoppinglist-loaded",j,a),f.resolve({success:!0,response:j}),j.deferred=null):d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/ItemsBy/"+j.ShoppingListId+"?nocache="+(new Date).getTime(),e=d.getApiHeaders();e.shopping_list_id=j.ShoppingListId,c.get(a,{headers:e}).success(function(a){i(a),f.resolve({success:!0,response:j}),j.deferred=null}).error(function(a){b.$broadcast("gsnevent:shoppinglist-loadfail",a),f.resolve({success:!1,response:a}),j.deferred=null})})),j.deferred.promise},j}return f}var c="gsnList";a.module("gsn.core").factory(c,["$rootScope","$http","gsnApi","$q",b])}(angular),function(a){"use strict";function b(a,b,c,d){var e={};return e.GetCardMember=function(a){var e=c.defer(),f=b.getMidaxServiceUrl()+"/GetCardMember/"+b.getChainId()+"/"+b.getProfileId()+"/"+a;return d.get(f).success(function(a){e.resolve({success:a.Success,response:a.Response})}).error(function(a){e.resolve({success:!1,response:a.Response})}),e.promise},e.SaveCardMember=function(a){var e=c.defer(),f=b.getMidaxServiceUrl()+"/SaveCardMember/"+b.getChainId()+"/"+b.getProfileId();return d.post(f,a).success(function(a){e.resolve({success:a.Success,response:a.Response,message:a.Message})}).error(function(a){e.resolve({success:!1,response:a.Response,message:a.Message})}),e.promise},e.GetFuelPointsHistory=function(a){var e=c.defer(),f=b.getMidaxServiceUrl()+"/GetFuelPointsHistory/"+b.getChainId()+"/"+b.getProfileId()+"/"+a;return d.get(f).success(function(a){e.resolve({success:a.Success,response:a.Response})}).error(function(a){e.resolve({success:!1,response:a.Response})}),e.promise},e}var c="gsnMidax";a.module("gsn.core").service(c,["$rootScope","gsnApi","$q","$http",b])}(angular),function(a){"use strict";var b=a.module("gsn.core");b.service("$notification",["$rootScope","$window",function(a,b){var c={alert:function(a){return b.isPhoneGap?void navigator.notification.alert(a,null,"","OK"):void b.alert(a)},confirm:function(a,c,d,e){return null===gsn.isNull(e,null)&&(e="OK,Cancel"),b.isPhoneGap?void navigator.notification.confirm(a,c,d,e.split(",")):void c(b.confirm(a)?1:2)},prompt:function(a,c,d,e,f){if(null===gsn.isNull(f,null)&&(f="OK,Cancel"),null===gsn.isNull(e,null)&&(e=""),!b.isPhoneGap){var g=b.prompt(a,e);return void c({buttonIndex:g?1:2,input1:g})}navigator.notification.prompt(a,c,d,f.split(","),e)}};return c}]),b.factory("FeedService",["$http","gsnApi",function(a,b){return{parseFeed:function(c,d){return a.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num="+b.isNull(d,50)+"&callback=JSON_CALLBACK&q="+encodeURIComponent(c))}}}]),b.factory("gsnAuthenticationHandler",["$rootScope","$q",function(a,b){var c={responseError:function(c){return 401==c.status?a.$broadcast("gsnevent:auth-expired",arguments):400==c.status&&c.data&&"string"==typeof c.data&&(c.data.indexOf("refresh_token is invalid or has expired")>-1||c.data.indexOf("Illegal attempt to refresh an anonymous token for user that is no longer anonymous.")>-1)&&a.$broadcast("gsnevent:auth-invalidrefresh",arguments),b.reject(c)}};return c}]),b.directive("bsDisplayMode",["$window","$timeout",function(b,c){return{template:'<div class="visible-xs"></div><div class="visible-sm"></div><div class="visible-md"></div><div class="visible-lg"></div>',restrict:"EA",replace:!1,link:function(d,e,f){function g(){a.forEach(h,function(b){a.element(b).is(":visible")&&(d[f.bsDisplayMode]=b.className)})}var h=e.find("div");a.element(b).bind("resize",function(){c(g,300)}),g()}}}]),b.directive("ngScrollTop",["$window","$timeout",function(b,c){function d(d,e,g){f++;var h=parseInt(a.element(b).scrollTop());d[g.ngScrollTop]=h,a.element(b).on("scroll",function(){c(function(){h=parseInt(a.element(b).scrollTop()),d[g.ngScrollTop]=h,e.css({display:h>parseInt(g.offset)&&1==f?"block":""})},300)}),e.on("click",function(){a.element(b).scrollTop(0)}),d.$on("$destroy",function(){f--})}var e={link:d,restrict:"A"},f=0;return e}])}(angular),function(a){"use strict";function b(b,c,d,e,f,g,h,i,j){function k(){var b=a.element("#ci_div1");if(b.length<=0){var c=a.element('<div id="ci_div1"></div><div id="ci_div2"></div><iframe src="about:blank" id="pmgr" width="1" height="1" style="visibility: hidden"></iframe>'),d=a.element("body");a.forEach(c,function(a){d[0].appendChild(a)})}}function l(){c(m,50)}function m(){if(!(q.coupons<=0)){var g="Your coupon(s) were unavailable for printing. You may have already printed this coupon the maximum number of times.";e.getAccessToken().then(function(){var h=e.getShoppingListApiUrl()+"/CouponPrintScript/"+e.getChainId()+"?nocache="+(new Date).getTime(),i=[],j="",k=[];a.forEach(q.coupons,function(a){i.push(a.ProductCode),j+=","+a.ProductCode,k.push(".coupon-message-"+a.ProductCode)});var l=a.element(k.join(","));q.printed||(q.printed=!0,d.post(h,{Coupons:i,DeviceId:q.printerCode},{headers:e.getApiHeaders()}).success(function(d){if(d.Success){if(l.length<=0)return;c(function(){q.checkStatus||l.html("Printing...");var c="",h=e.isNull(d.ErrorCoupons,[]);h.length>0&&(a.forEach(h,function(b){a.element(".coupon-message-"+b.CouponId).html(b.ErrorMessage),c+=","+b.CouponId}),b.$broadcast("gsnevent:couponprinting-error",h)),q.callBack&&q.callBack.failedCoupons&&q.callBack.failedCoupons(h),q.checkStatus||(q.callBack&&q.callBack.readyAlert?q.callBack.readyAlert(q.coupons.length-h.length,function(){n(h,l,d)
}):(g='Click "OK" to print your manufacturer coupon(s).',q.printNow&&(g+='  Use the "Print" button to print your List.'),q&&f.confirm(g,function(a){1==a&&n(h,l,d)})))},50)}else c(function(){f.alert(g)},50)}).error(function(){c(function(){l.html("Print Limit Reached"),f.alert(g)},50)}))})}}function n(b,c,d){if(a.forEach(q.coupons,function(a){j.addPrinted(a.ProductCode)}),q.callBack&&q.callBack.result){var e=b.length,f=q.coupons.length-b.length;q.callBack.result(f,e)}p(d.DeviceId,d.Token)}function o(b,d,f,g){k(),q.coupons=e.isNull(b,[]),q.checkStatus=g,q.printNow=d,q.callBack=f;var h=[];if(a.forEach(q.coupons,function(a){h.push(".coupon-message-"+a.ProductCode)}),q.callBack||c(function(){a.element(h.join(",")).html("Checking...")},5),e.isNaN(parseInt(q.printerCode),0)>0)q.printed=!1,l();else{if(q.hasInit)return;q.hasInit=!0;var i=e.getApiUrl()+"/ShoppingList/CouponInitScriptFromBrowser/"+e.getChainId()+"?callbackFunc=showResultOfDetectControl&nocache="+e.getVersion();e.loadScripts([i],function(){})}}function p(b,c){if(e.isNull(c,"").length>0){var d="http://insight.coupons.com/cos20/printmanager.aspx";d+="?PID="+b,d+="&PrintCartToken="+encodeURIComponent(c),d+="&PostBackURL="+encodeURIComponent("http://insight.coupons.com/cos20/ThankYou.aspx");var f=a.element("#pmgr");f.length>0?f.attr("src",d):h.warn("Frame does not exist")}}var q={initPrinter:o,printerCode:0,hasInit:!1,printed:!1,printNow:!1,coupons:[],callBack:null,checkStatus:!1};return g.showResultOfDetectControl=function(a){if(!q.printed){var d=e.isNaN(parseFloat(a),0);if(d>0)q.printerCode=d,l();else{if(q.hasInit=!1,q.printed)return;var g="It's possible that the CI coupon printer installed plugin has been disabled.  Please make sure to enable CI coupon printer browser plugin.";if("BLOCKED"==a)return void(q.callBack&&q.callBack.blocked?q.callBack.blocked():f.alert(g));if("ERROR"==a)g="The CI coupon printer has thrown an error that cannot be recovered.  You may need to uninstall and reinstall the CI coupon printer to fix this issue.",f.alert(g);else if("function"==typeof ci_downloadFFSilent){if(q.printed)return;q.callBack&&q.callBack.notInstalled?q.callBack.notInstalled(ci_downloadFFSilent):c(ci_downloadFFSilent,5)}b.$broadcast("gsnevent:printerdownload-instruction",q)}}},q}var c="gsnPrinter";a.module("gsn.core").factory(c,["$rootScope","$timeout","$http","gsnApi","$notification","$window","$log","$analytics","gsnProfile",b])}(angular),function(a){"use strict";function b(b,c,d,e,f,g,h,i,j,k,l){function m(){var a=d.getProfileApiUrl()+"/By/"+o.getProfileId();c.get(a,{headers:d.getApiHeaders()}).success(function(a){s.profile=a,b.$broadcast("gsnevent:profile-load-success",{success:!0,response:s.profile}),q.resolve({success:!0,response:s.profile}),q=null}).error(function(a){b.$broadcast("gsnevent:profile-load-failed",{success:!1,response:a}),q.resolve({success:!1,response:a}),q=null})}function n(a,b){var f=e.defer(),g=d.isNull(a.Email,"").replace(/\s+/gi,""),h=d.isNull(a.UserName,"").replace(/\s+/gi,"");h.length<=0&&(h=g),g.length<=0&&(g=null),h.length<=0&&(h=null);var i={Email:g,UserName:h,Password:d.isNull(a.Password,""),ReceiveEmail:d.isNull(a.ReceiveEmail,!0),ReceiveSms:d.isNull(a.ReceiveSms,!0),Phone:d.isNull(a.Phone,"").replace(/[^0-9]+/gi,""),PrimaryStoreId:d.isNull(a.PrimaryStoreId,d.getSelectedStoreId()),FirstName:d.isNull(a.FirstName,"").replace(/[`]+/gi,"'"),LastName:d.isNull(a.LastName,"").replace(/[`]+/gi,"'"),ExternalId:a.ExternalId,WelcomeSubject:a.WelcomeSubject,WelcomeMessage:a.WelcomeMessage,FacebookUserId:a.FacebookUserId,SiteId:d.getChainId(),Id:d.getProfileId()};return""===i.Password&&(i.Password=null),""===i.LastName&&(i.LastName=null),""===i.FirstName&&(i.FirstName=null),d.isNull(i.PrimaryStoreId,0)<=0&&(i.PrimaryStoreId=null),d.isNull(a.ExternalId,"").length<=0&&(a.ExternalId=null),d.isNull(a.FacebookUserId,"").length<=0&&(a.FacebookUserId=null),i.UserName.length<3?(f.resolve({success:!1,response:"Email/UserName must be at least 3 characters."}),f.promise):!b&&d.isNull(a.FacebookToken,"").length<=0&&d.isNull(i.Password,"").length<6?(f.resolve({success:!1,response:"Password must be at least 6 characters."}),f.promise):d.getEmailRegEx().test(i.Email)?(d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+(b?"/Update":"/Register");d.isNull(a.FacebookToken,"").length>1&&(e+="Facebook",i.Password=a.FacebookToken),c.post(e,i,{headers:d.getApiHeaders()}).success(function(a){s.profile=a,f.resolve({success:!0,response:a})}).error(function(a){f.resolve({success:!1,response:a})})}),f.promise):(f.resolve({success:!1,response:"Email is invalid."}),f.promise)}var o={},p=d.getProfileId(),q=null,r=null,s={allShoppingLists:{},profile:null,profileData:{scoredProducts:{},circularItems:{},availableCoupons:{},myPantry:{}}};return o.getShoppingListId=d.getShoppingListId,o.getProfileId=d.getProfileId,o.createNewShoppingList=function(){return r?r.promise:(r=e.defer(),d.getAccessToken().then(function(){var a=d.getShoppingListApiUrl()+"/Create/"+d.getProfileId();c.post(a,{},{headers:d.getApiHeaders()}).success(function(a){var c=a;s.allShoppingLists[c.Id]=f(c.Id,c),d.setShoppingListId(c.Id),b.$broadcast("gsnevent:shoppinglist-created",s.allShoppingLists[c.Id]),r.resolve({success:!0,response:s.allShoppingLists[c.Id]}),r=null}).error(function(a){r.resolve({success:!1,response:a}),r=null})}),r.promise)},o.login=function(a,b){var c={grant_type:"password",client_id:d.getChainId(),access_type:"offline",username:a,password:b};d.doAuthenticate(c)},o.loginFacebook=function(a,b){var c={grant_type:"facebook",client_id:d.getChainId(),access_type:"offline",username:a,password:b};d.doAuthenticate(c)},o.initialize=function(){var a=parseInt(d.isNull(o.getProfileId(),0));a>0&&o.getProfile(!0),g.initialize()},o.logOut=function(){d.logOut(),k.clipped=[],k.printed=[],k.preClipped={}},o.addItem=function(a){var b=o.getShoppingList();b&&(d.isNull(a.ItemTypeId,0)<=0&&(a.ItemTypeId=6),b.addItem(a))},o.addItems=function(a){var b=o.getShoppingList();return b.addItems(a)},o.isOnList=function(a){var b=o.getShoppingList();if(b){var c=b.getItem(a.ItemId,a.ItemTypeId);return null!==d.isNull(c,null)}return!1},o.removeItem=function(a){var b=o.getShoppingList();b&&b.removeItem(a)},o.deleteShoppingList=function(a){a.deleteList(),delete s.allShoppingLists[a.ShoppingListId]},o.getShoppingList=function(a){null===d.isNull(a,null)&&(a=o.getShoppingListId());var b=s.allShoppingLists[a];return b},o.getShoppingLists=function(){var b=[];return a.forEach(s.allShoppingLists,function(a){b.push(a)}),d.sortOn(b,"ShoppingListId"),b.reverse(),b},o.getShoppingListCount=function(){var a=o.getShoppingList();return a?a.getCount():0},o.getProfile=function(a){return q?q.promise:(q=e.defer(),null===d.isNull(s.profile,null)||a?(i(function(){s={allShoppingLists:{},profile:null,profileData:{scoredProducts:{},circularItems:{},availableCoupons:{},myPantry:{}}},o.refreshShoppingLists()},5),d.getAccessToken().then(function(){d.isAnonymous()?(s.profile={Id:o.getProfileId(),SiteId:d.getChainId(),PrimaryStoreId:d.getSelectedStoreId()},b.$broadcast("gsnevent:profile-load-success",{success:!0,response:s.profile}),q.resolve({success:!0,response:s.profile}),q=null):d.getConfig().hasRoundyProfile?l.getProfile().then(function(a){a.success?(s.profile=a.response,b.$broadcast("gsnevent:profile-load-success",{success:!0,response:s.profile}),q.resolve(a),q=null):m()}):m()})):i(function(){q.resolve({success:!0,response:s.profile}),q=null},10),q.promise)},o.registerProfile=function(a){return n(a,!1)},o.changePassword=function(a,b,f){var g=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/ChangePassword";c.post(e,{UserName:a,Password:b,NewPassword:f},{headers:d.getApiHeaders()}).success(function(a){g.resolve({success:"true"==a,response:a})}).error(function(a){g.resolve({success:!1,response:a})})}),g.promise},o.recoverPassword=function(a){var b=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/RecoverPassword";c.post(e,a,{headers:d.getApiHeaders()}).success(function(a){b.resolve({success:"true"==a,response:a})}).error(function(a){b.resolve({success:!1,response:a})})}),b.promise},o.recoverUsername=function(a){var b=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/RecoverUsername";c.post(e,a,{headers:d.getApiHeaders()}).success(function(a){b.resolve({success:"true"==a,response:a})}).error(function(a){b.resolve({success:!1,response:a})})}),b.promise},o.unsubscribeEmail=function(a){var b=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/Unsubscribe/?email="+encodeURIComponent(a);c.post(e,{email:a},{headers:d.getApiHeaders()}).success(function(a){b.resolve({success:!0,response:a})}).error(function(a){b.resolve({success:!1,response:a})})}),b.promise},o.updateProfile=function(a){return n(a,!0)},o.refreshShoppingLists=function(){if(o.refreshingDeferred)return o.refreshingDeferred.promise;var a=e.defer();return o.refreshingDeferred=a,s.allShoppingLists={},d.getAccessToken().then(function(){var e=d.getShoppingListApiUrl()+"/List/"+d.getProfileId();c.get(e,{headers:d.getApiHeaders()}).success(function(c){if(c.length>0)for(var e=0;e<c.length;e++){var g=c[e];g.ShoppingListId=g.Id;var h=f(g.ShoppingListId,g);s.allShoppingLists[g.ShoppingListId]=h,0===e&&(h.updateShoppingList(),d.setShoppingListId(g.ShoppingListId))}else o.createNewShoppingList();o.refreshingDeferred=null,b.$broadcast("gsnevent:shoppinglists-loaded",{success:!0,response:c}),a.resolve({success:!0,response:c})}).error(function(b){o.refreshingDeferred=null,a.resolve({success:!1,response:b})})}),a.promise},o.getMyCircularItems=function(){var a=d.getProfileApiUrl()+"/GetCircularItems/"+d.getProfileId();return d.httpGetOrPostWithCache(s.profileData.circularItems,a)},o.getMyPantry=function(a,b){var c=d.getProfileApiUrl()+"/GetPantry/"+d.getProfileId()+"?departmentId="+d.isNull(a,"")+"&categoryId="+d.isNull(b,"");return d.httpGetOrPostWithCache(s.profileData.myPantry,c)},o.getMyProducts=function(){var a=d.getProfileApiUrl()+"/GetScoredProducts/"+d.getProfileId();return d.httpGetOrPostWithCache(s.profileData.scoredProducts,a)},o.getMyRecipes=function(){var a=d.getProfileApiUrl()+"/GetSavedRecipes/"+d.getProfileId();return d.httpGetOrPostWithCache({},a)},o.rateRecipe=function(a,b){var c=d.getProfileApiUrl()+"/RateRecipe/"+a+"/"+d.getProfileId()+"/"+b;return d.httpGetOrPostWithCache({},c,{})},o.getMyRecipe=function(a){var b=d.getProfileApiUrl()+"/GetSavedRecipe/"+d.getProfileId()+"/"+a;return d.httpGetOrPostWithCache({},b)},o.saveRecipe=function(a,b){var c=d.getProfileApiUrl()+"/SaveRecipe/"+a+"/"+d.getProfileId()+"?comment="+encodeURIComponent(b);return d.httpGetOrPostWithCache({},c,{})},o.saveProduct=function(a,b){var c=d.getProfileApiUrl()+"/SaveProduct/"+a+"/"+d.getProfileId()+"?comment="+encodeURIComponent(b);return d.httpGetOrPostWithCache({},c,{})},o.selectStore=function(a){var b=d.getProfileApiUrl()+"/SelectStore/"+d.getProfileId()+"/"+a;return d.httpGetOrPostWithCache({},b,{})},o.getCampaign=function(){var a=d.getProfileApiUrl()+"/GetCampaign/"+d.getProfileId();return d.httpGetOrPostWithCache({},a)},o.resetCampaign=function(){j.GsnCampaign=0},o.sendContactUs=function(a){var b=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/SendContactUs";c.post(e,a,{headers:d.getApiHeaders()}).success(function(a){b.resolve({success:!0,response:a})}).error(function(a){b.resolve({success:!1,response:a})})}),b.promise},o.sendEmail=function(a){var b=e.defer();return d.getAccessToken().then(function(){var e=d.getProfileApiUrl()+"/SendEmail";c.post(e,a,{headers:d.getApiHeaders()}).success(function(a){b.resolve({success:!0,response:a})}).error(function(a){b.resolve({success:!1,response:a})})}),b.promise},o.clipCoupon=function(a){k.clipped||(k.clipped=[]),k.clipped.indexOf(a)<0&&k.clipped.push(a)},o.unclipCoupon=function(a){var b=k.clipped.indexOf(a);k.clipped.splice(b,1)},o.getClippedCoupons=function(){return k.clipped},o.savePreclippedCoupon=function(a){k.preClipped=a},o.getPreclippedCoupon=function(){return k.preClipped},o.addPrinted=function(a){k.printed||(k.printed=[]),k.printed.indexOf(a)<0&&k.printed.push(a)},o.getPrintedCoupons=function(){return k.printed},b.$on("gsnevent:shoppinglist-item-response",function(a,b){var c=b[1],e=b[2],f=b[3];d.isLoggedIn()&&(e.ItemId!=c.ItemId&&(delete f.items[e.ItemId],e.ItemId=c.ItemId),e.zPriceMultiple&&(c.PriceMultiple=e.zPriceMultiple),c.Order=e.Order,f.items[e.ItemId]=c.d)}),b.$on("gsnevent:profile-setid",function(a,b){p!=b&&(p=b,o.getProfile(!0),o.resetCampaign())}),b.$on("gsnevent:profile-load-success",function(a,b){d.isNull(b.response.PrimaryStoreId,0)>0&&d.setSelectedStoreId(b.response.PrimaryStoreId)}),b.$on("gsnevent:store-setid",function(a,b){if(b.newValue!=b.oldValue){var c=o.getShoppingList();c&&c.updateShoppingList()}}),o}var c="gsnProfile";a.module("gsn.core").service(c,["$rootScope","$http","gsnApi","$q","gsnList","gsnStore","$location","$timeout","$sessionStorage","$localStorage","gsnRoundyProfile",b])}(angular),function(a){"use strict";function b(a,b,c,d,e){function f(){h.profile={Email:null,PrimaryStoreId:null,FirstName:null,LastName:null,Phone:null,AddressLine1:null,AddressLine2:null,City:null,State:null,PostalCode:null,FreshPerksCard:null,ReceiveEmail:!1,Id:null,IsECard:!1}}function g(a,b){b.resolve({success:!1,response:a}),d.$broadcast("gsnevent:roundy-error",{success:!1,response:a})}var h={};return h.profile={},h.getProfileDefer=null,f(),h.saveProfile=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/SaveProfile/"+a.getChainId();d.PostalCode&&(d.PostalCode=d.PostalCode.substr(0,5)),b.post(c,d,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.validateLoyaltyCard=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/ValidateLoyaltyCard/"+a.getChainId()+"/"+a.getProfileId()+"?loyaltyCardNumber="+d;b.get(c,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.removeLoyaltyCard=function(){var d=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/RemoveLoyaltyCard/"+a.getChainId()+"/"+a.getProfileId();b.get(c,{headers:a.getApiHeaders()}).success(function(a){d.resolve({success:!0,response:a})}).error(function(a){g(a,d)})}),d.promise},h.getProfile=function(d){var f;return h.profile.FirstName&&!d?(f=c.defer(),e(function(){f.resolve({success:!0,response:h.profile})},500)):h.getProfileDefer?f=h.getProfileDefer:(h.getProfileDefer=c.defer(),f=h.getProfileDefer,a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/GetProfile/"+a.getChainId()+"/"+a.getProfileId();b.get(c,{headers:a.getApiHeaders()}).success(function(a){if(h.profile=a,a.ExternalId&&(h.profile.FreshPerksCard=a.ExternalId),a.PostalCode)for(;h.profile.PostalCode.length<5;)h.profile.PostalCode+="0";f.resolve({success:!0,response:a}),h.getProfileDefer=null}).error(function(a){g(a,f)})})),f.promise},h.mergeAccounts=function(d,e){var f=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/MergeAccounts/"+a.getChainId()+"/"+a.getProfileId()+"?newCardNumber="+d+"&updateProfile="+e;b.post(c,{},{headers:a.getApiHeaders()}).success(function(a){f.resolve({success:!0,response:a})}).error(function(a){g(a,f)})}),f.promise},h.removePhone=function(){var d=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/SavePhoneNumber/"+a.getChainId()+"/"+a.getProfileId()+"?phoneNumber=";b.post(c,{},{headers:a.getApiHeaders()}).success(function(a){h.profile.Phone=null,d.resolve({success:!0,response:a})}).error(function(a){g(a,d)})}),d.promise},h.savePhonNumber=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/SavePhoneNumber/"+a.getChainId()+"/"+a.getProfileId()+"?phoneNumber="+d;b.post(c,{},{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.isValidPhone=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/IsValidPhone/"+a.getChainId()+"/"+h.profile.FreshPerksCard+"?phone="+d;b.get(c,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.profileByCardNumber=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/ProfileBy/"+a.getChainId()+"/"+d;b.get(c,{headers:a.getApiHeaders()}).success(function(a){"object"==typeof a&&a.FirstName?e.resolve({success:!0,response:a}):g(a,e)}).error(function(a){g(a,e)})}),e.promise},h.registerLoyaltyCard=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/RegisterLoyaltyCard/"+a.getChainId()+"/"+a.getProfileId();d.PostalCode&&(d.PostalCode=d.PostalCode.substr(0,5)),b.post(c,d,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.registerELoyaltyCard=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/RegisterELoyaltyCard/"+a.getChainId()+"/"+a.getProfileId();d.PostalCode&&(d.PostalCode=d.PostalCode.substr(0,5)),b.post(c,d,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},h.associateLoyaltyCardToProfile=function(d){var e=c.defer();return a.getAccessToken().then(function(){var c=a.getRoundyProfileUrl()+"/AssociateLoyaltyCardToProfile/"+a.getChainId()+"/"+a.getProfileId()+"?loyaltyCardNumber="+d;b.get(c,{headers:a.getApiHeaders()}).success(function(a){e.resolve({success:!0,response:a})}).error(function(a){g(a,e)})}),e.promise},d.$on("gsnevent:logout",function(){f()}),h}var c="gsnRoundyProfile";a.module("gsn.core").service(c,["gsnApi","$http","$q","$rootScope","$timeout",b])}(angular),function(a,b){"use strict";function c(a,c,d,e,f,g){var h={hasInit:!1};return h.init=function(a){function c(){var a=localStorage.getItem("gsnStorage-accessToken");return"string"==typeof a?b.fromJson(a):{}}if(!h.hasInit){h.hasInit=!0;var i=null,j=function(a,b){"function"==typeof a&&a({success:!0,response:b})},k=new easyXDM.Rpc(a,{remote:{triggerEvent:{}},local:{authenticate:function(a,b,c){e.doAuthenticate({grant_type:a,client_id:e.getChainId(),access_type:"offline",username:b,password:c})},apiGet:function(a,b,c){e.httpGetOrPostWithCache(a||{},b).then(c)},apiPost:function(a,b,c,d){e.httpGetOrPostWithCache(a||{},b,c||{}).then(d)},getToken:function(a){j(a,c())},getSiteId:function(a){j(a,e.getChainId())},getStoreId:function(a){j(a,e.getSelectedStoreId())},getProfileId:function(a){j(a,e.getProfileId())},getShoppingListId:function(a){j(a,e.getSelectedShoppingListId())},getConfig:function(a){j(a,e.getConfig())},mylist_addItem:function(a,b){f.addItem(a),j(b)},mylist_updateItem:function(a,b){f.addItem(a),j(b)},mylist_deleteItem:function(a){f.removeItem(item),j(a)},mylist_deleteList:function(a){f.deleteShoppingList(),j(a)},mylist_startNewList:function(a){f.createNewShoppingList().then(a)},mylist_refreshList:function(a){f.getShoppingList().updateShoppingList().then(a)},mylist_getTitle:function(a){j(a,f.getShoppingList().getTitle())},mylist_getCount:function(a){j(a,f.getShoppingListCount())},profile_register:function(a,b){f.registerProfile(a).then(b)},profile_update:function(a,b){f.updateProfile(a).then(b)},profile_recoverUsername:function(a,b){f.recoverUsername({Email:a}).then(b)},profile_recoverPassword:function(a,b){f.recoverPassword({Email:a}).then(b)},profile_changePassword:function(a,b,c,d){f.changePassword(a,b,c).then(d)},profile_selectStore:function(a,b){f.selectStore(a).then(b)},profile_get:function(a){f.getProfile().then(function(b){j(a,b)})},profile_logOut:function(a){f.logOut(),j(a)},profile_isLoggedIn:function(a){j(a,"anonymous"!==c().grant_type)},profile_getStore:function(a){g.getStore().then(function(b){a({success:null!==e.isNull(b,null),response:b})})},store_hasCompleteCircular:function(a){j(a,g.hasCompleteCircular())},store_getCircular:function(a){j(a,g.getCircularData())},store_getCategories:function(a){j(a,g.getCategories())},store_getInventoryCategories:function(a){j(a,g.getInventoryCategories())},store_getSaleItemCategories:function(a){j(a,g.getSaleItemCategories())},store_refreshCircular:function(a,b){j(b,g.refreshCircular(a))},store_searchProducts:function(a,b){g.searchProducts(a).then(b)},store_searchRecipes:function(a,b){g.searchRecipes(a).then(b)},store_getAvailableVarieties:function(a,b){g.getAvailableVarieties(a).then(b)},store_getAskTheChef:function(a){g.getAskTheChef().then(a)},store_getFeaturedArticle:function(a){g.getFeaturedArticle().then(a)},store_getCookingTip:function(a){g.getCookingTip().then(a)},store_getTopRecipes:function(a){g.getTopRecipes().then(a)},store_getFeaturedRecipe:function(a){g.getFeaturedRecipe().then(a)},store_getManufacturerCoupons:function(a){j(a,g.getManufacturerCoupons())},store_getManufacturerCouponTotalSavings:function(a){g.getManufacturerCouponTotalSavings().then(a)},store_getStates:function(a){g.getStates().then(a)},store_getInstoreCoupons:function(a){j(a,g.getInstoreCoupons())},store_getYoutechCoupons:function(a){j(a,g.getYoutechCoupons())},store_getRecipe:function(a,b){g.getFeaturedRecipe(a).then(b)},store_getStaticContent:function(a,b){g.getStaticContent(a).then(b)},store_getArticle:function(a,b){g.getArticle(a).then(b)},store_getSaleItems:function(a,b,c){g.getSaleItems(a,b).then(c)},store_getInventory:function(a,b,c){g.getInventory(a,b).then(c)},store_getSpecialAttributes:function(a){g.getSpecialAttributes().then(a)},store_getMealPlannerRecipes:function(a){g.getMealPlannerRecipes().then(a)},store_getAdPods:function(a){g.getAdPods().then(a)},store_getStores:function(a){getStores().then(function(b){j(a,b)})}}});setInterval(function(){var a=c();if(a){var b=e.isNull(i,{});if(b.user_id!==a.user_id){i=a;var d=parseInt(i.user_id);e.setAccessToken(i),k.triggerEvent({type:"gsnevent:profile-changed",arg:d})}}},2e3),d.$on("gsnevent:login-success",function(a,b){k.triggerEvent({type:"gsnevent:login-success",arg:b.response})}),d.$on("gsnevent:login-failed",function(a,b){k.triggerEvent({type:"gsnevent:login-failed",arg:b.response})})}},h}var d="$gsnSdk";b.module("gsn.core").service(d,["$window","$timeout","$rootScope","gsnApi","gsnProfile","gsnStore","gsnDfp","gsnYoutech",c])}(window.Gsn,angular),function(a){"use strict";function b(b){return["$rootScope","$window","$log",function(e,f,g){function h(a){var b=f[a];if(b&&"localStorage"===a){var c="__"+Math.round(1e7*Math.random());try{localStorage.setItem(c,c),localStorage.removeItem(c)}catch(d){b=!1}}return b}for(var i,j,k,l=h(b)||(g.warn("This browser does not support Web Storage!"),d),m={$default:function(b){for(var c in b)a.isDefined(m[c])||(m[c]=b[c]);return m},$reset:function(a){for(var b in m)"$"===b[0]||delete m[b];return m.$default(a)}},n=0;n<l.length;n++)(k=l.key(n))&&c===k.slice(0,c.length)&&(m[k.slice(c.length)]=a.fromJson(l.getItem(k)));return i=a.copy(m),e.$watch(function(){j||(j=setTimeout(function(){if(j=null,!a.equals(m,i)){a.forEach(m,function(b,d){a.isDefined(b)&&"$"!==d[0]&&l.setItem(c+d,a.toJson(b)),delete i[d]});for(var b in i)l.removeItem(c+b);i=a.copy(m)}},100))}),"localStorage"===b&&f.addEventListener&&f.addEventListener("storage",function(b){if(c===b.key.slice(0,c.length)){if("undefined"==typeof b.newValue)return;b.newValue?m[b.key.slice(c.length)]=a.fromJson(b.newValue):delete m[b.key.slice(c.length)],i=a.copy(m),e.$apply()}}),m}]}var c="gsnStorage-",d={};a.module("gsn.core").factory("$localStorage",b("localStorage")).factory("$sessionStorage",b("sessionStorage"))}(angular),function(a){"use strict";function b(a,b,c,d,e,f,g,h,i){function j(a){var b=i.search().selectFirstStore;a=c.isNull(a,[]),(1==a.length||b)&&a[0].StoreId!=c.isNull(c.getSelectedStoreId(),0)&&c.setSelectedStoreId(a[0].StoreId)}function k(){var a=t.getCircularData();u.manufacturerCoupons.items=a.ManufacturerCoupons,c.forEach(u.manufacturerCoupons.items,function(a){a.CategoryName=c.isNull(w.categoryById[a.CategoryId],{CategoryName:""}).CategoryName,w.manuCouponById[a.ItemId]=a})}function l(){var a=t.getCircularData();u.instoreCoupons.items=a.InstoreCoupons,c.forEach(u.instoreCoupons.items,function(a){a.CategoryName=c.isNull(w.categoryById[a.CategoryId],{CategoryName:""}).CategoryName,w.storeCouponById[a.ItemId]=a})}function m(){var a=t.getCircularData();u.youtechCoupons.items=a.YoutechCoupons,c.forEach(u.youtechCoupons.items,function(a){a.CategoryName=c.isNull(w.categoryById[a.CategoryId],{CategoryName:""}).CategoryName,w.youtechCouponById[a.ItemId]=a})}function n(){w&&(f(k,50),f(l,50),f(m,50))}function o(){var b=t.getCircularData();if(null!==c.isNull(b,null)){v.circularLastUpdate=(new Date).getTime(),u.storeId=b.StoreId,x.length=0,x.push(function(){var a=c.mapObject(b.Categories,"CategoryId");a[null]={CategoryId:null,CategoryName:""},a[-1]={CategoryId:-1,CategoryName:"Misc. Items"},a[-2]={CategoryId:-2,CategoryName:"Ingredients"},w.categoryById=a}),x.push(function(){var a=c.mapObject(b.Brands,"BrandId");a[null]={BrandId:null,BrandName:""},a[0]={BrandId:0,BrandName:""},w.brandById=a});var d=c.mapObject(b.CircularTypes,"Code"),e=[],f=[],g=[];c.forEach(b.Circulars,function(a){q(a,g,d,f,e)}),x.push(function(){c.sortOn(g,"Description"),e.push({CircularTypeId:99,CircularType:"All Circulars",items:g})}),x.push(function(){w.itemsById=c.mapObject(g,"ItemId")}),x.push(function(){w.circularByTypeId=c.mapObject(e,"CircularTypeId")}),x.push(function(){w.staticCircularById=c.mapObject(f,"CircularTypeId")}),n(),x.push(function(){a.$broadcast("gsnevent:circular-loaded",{success:!0,response:b})}),p()}}function p(){x.length>0&&(x.shift()(),f(p,50))}function q(a,b,d,e,f){var g=a.Pages,h=0;c.sortOn(g,"PageNumber"),a.pages=g,a.CircularType=d[a.CircularTypeId].Name;var i={CircularPageId:g[0].CircularPageId,CircularType:a.CircularType,CircularTypeId:a.CircularTypeId,ImageUrl:g[0].ImageUrl,SmallImageUrl:g[0].SmallImageUrl,items:[]};c.forEach(g,function(a){h+=a.Items.length,x.push(function(){r(b,i,a)})}),x.push(function(){c.isNull(h,0)>0?f.push(i):(i.items=g,e.push(i))})}function r(a,b,d){c.forEach(d.Items,function(c){b.items.push(c),a.push(c)})}var s,t={},u={manufacturerCoupons:{},instoreCoupons:{},youtechCoupons:{},quickSearchItems:{},topRecipes:{},faAskTheChef:{},faCookingTip:{},faArticle:{},faRecipe:{},faVideo:{},mealPlanners:{},manuCouponTotalSavings:{},states:{},adPods:{},specialAttributes:{},circular:null,storeList:null,rewardProfile:{},allVideos:[]},v=g,w={circularByTypeId:{},categoryById:{},brandById:{},itemsById:{},staticCircularById:{},storeCouponById:{},manuCouponById:{},youtechCouponById:{}},x=[];return t.getCircular=function(a){var b=w.circularByTypeId[a];return b},t.getCategories=function(){return w.categoryById},t.getInventoryCategories=function(){return c.isNull(v.circular,{}).InventoryCategories},t.getSaleItemCategories=function(){return c.isNull(v.circular,{}).SaleItemCategories},t.refreshCircular=function(){if(!u.circularIsLoading){u.storeId=c.getSelectedStoreId(),u.circular={},u.circularIsLoading=!0,a.$broadcast("gsnevent:circular-loading");var b=c.getStoreUrl()+"/AllContent/"+u.storeId;c.httpGetOrPostWithCache({},b).then(function(b){b.success?(u.circular=b.response,v.circular=b.response,o(),u.circularIsLoading=!1):(u.circularIsLoading=!1,a.$broadcast("gsnevent:circular-failed",b))})}},t.searchProducts=function(a){var b=c.getStoreUrl()+"/SearchProduct/"+c.getSelectedStoreId()+"?q="+encodeURIComponent(a);return c.httpGetOrPostWithCache({},b)},t.searchRecipes=function(a){var b=c.getStoreUrl()+"/SearchRecipe/"+c.getChainId()+"?q="+encodeURIComponent(a);return c.httpGetOrPostWithCache({},b)},t.getAvailableVarieties=function(a){var b=c.getStoreUrl()+"/GetAvailableVarieties/"+a;return c.httpGetOrPostWithCache({},b)},t.getQuickSearchItems=function(){var a=c.getStoreUrl()+"/GetQuickSearchItems/"+c.getChainId();return c.httpGetOrPostWithCache(u.quickSearchItems,a)},t.getStores=function(){var e=d.defer();if(null!==c.isNull(s,null))return s.promise;s=e;var g=v.storeList;return c.isNull(g,[]).length>0?f(function(){s=null,e.resolve({success:!0,response:g}),j(g)},10):(a.$broadcast("gsnevent:storelist-loading"),c.getAccessToken().then(function(){var d=c.getStoreUrl()+"/List/"+c.getChainId();b.get(d,{headers:c.getApiHeaders()}).success(function(b){s=null;var d=b;"string"!=typeof d&&(c.forEach(d,function(a){a.Settings=c.mapObject(a.StoreSettings,"StoreSettingId"),a.StateName=a.LinkState.Abbreviation}),v.storeList=d),e.resolve({success:!0,response:d}),a.$broadcast("gsnevent:storelist-loaded"),j(d)})})),e.promise},t.getStore=function(){var a=d.defer();return t.getStores().then(function(b){var d=c.mapObject(b.response,"StoreId"),e=d[c.getSelectedStoreId()];a.resolve(e)}),a.promise},t.getItem=function(a){var b=w.itemsById[a];return null!==gsn.isNull(b,null)?b:null},t.getAskTheChef=function(){var a=c.getStoreUrl()+"/FeaturedArticle/"+c.getChainId()+"/1";return c.httpGetOrPostWithCache(u.faAskTheChef,a)},t.getFeaturedArticle=function(){var a=c.getStoreUrl()+"/FeaturedArticle/"+c.getChainId()+"/2";return c.httpGetOrPostWithCache(u.faArticle,a)},t.getFeaturedVideo=function(){var a=c.getStoreUrl()+"/FeaturedVideo/"+c.getChainId();return c.httpGetOrPostWithCache(u.faVideo,a)},t.getRecipeVideos=function(){var a=c.getStoreUrl()+"/RecipeVideos/"+c.getChainId();return c.httpGetOrPostWithCache(u.allVideos,a)},t.getCookingTip=function(){var a=c.getStoreUrl()+"/FeaturedArticle/"+c.getChainId()+"/3";return c.httpGetOrPostWithCache(u.faCookingTip,a)},t.getTopRecipes=function(){var a=c.getStoreUrl()+"/TopRecipes/"+c.getChainId()+"/"+c.getMaxResultCount();return c.httpGetOrPostWithCache(u.topRecipes,a)},t.getFeaturedRecipe=function(){var a=c.getStoreUrl()+"/FeaturedRecipe/"+c.getChainId();return c.httpGetOrPostWithCache(u.faRecipe,a)},t.getCoupon=function(a,b){return 2==b?w.manuCouponById[a]:10==b?w.storeCouponById[a]:w.youtechCouponById[a]},t.getManufacturerCoupons=function(){return u.manufacturerCoupons},t.getOrLoadManufacturerCoupons=function(){var a=c.getStoreUrl()+"/ManufacturerCoupons/"+c.getSelectedStoreId();return c.httpGetOrPostWithCache(u.manufacturerCoupons,a)},t.getManufacturerCouponTotalSavings=function(){var a=c.getStoreUrl()+"/GetManufacturerCouponTotalSavings/"+c.getChainId();return c.httpGetOrPostWithCache(u.manuCouponTotalSavings,a)},t.getStates=function(){var a=c.getStoreUrl()+"/GetStates";return c.httpGetOrPostWithCache(u.states,a)},t.getInstoreCoupons=function(){return u.instoreCoupons},t.getYoutechCoupons=function(){return u.youtechCoupons},t.getOrLoadYoutechCoupons=function(){var a=c.getStoreUrl()+"/YoutechCoupons/"+c.getSelectedStoreId();return c.httpGetOrPostWithCache(u.youtechCoupons,a)},t.getRecipe=function(a){var b=c.getStoreUrl()+"/RecipeBy/"+a;return c.httpGetOrPostWithCache({},b)},t.getStaticContent=function(a){var b=c.getStoreUrl()+"/GetPartials/"+c.getChainId()+"/",d=c.isNull(c.getSelectedStoreId(),0);return d>0&&(b+=d+"/"),b+="?name="+encodeURIComponent(a),c.httpGetOrPostWithCache({},b)},t.getPartial=function(a){var b=c.getContentServiceUrl("GetPartial");return b+="?name="+encodeURIComponent(a),c.httpGetOrPostWithCache({},b)},t.getArticle=function(a){var b=c.getStoreUrl()+"/ArticleBy/"+a;return c.httpGetOrPostWithCache({},b)},t.getSaleItems=function(a,b){var d=c.getStoreUrl()+"/FilterSaleItem/"+c.getSelectedStoreId()+"?departmentId="+c.isNull(a,"")+"&categoryId="+c.isNull(b,"");return c.httpGetOrPostWithCache({},d)},t.getInventory=function(a,b){var d=c.getStoreUrl()+"/FilterInventory/"+c.getSelectedStoreId()+"?departmentId="+c.isNull(a,"")+"&categoryId="+c.isNull(b,"");return c.httpGetOrPostWithCache({},d)},t.getSpecialAttributes=function(){var a=c.getStoreUrl()+"/GetSpecialAttributes/"+c.getChainId();
return c.httpGetOrPostWithCache(u.specialAttributes,a)},t.getMealPlannerRecipes=function(){var a=c.getStoreUrl()+"/GetMealPlannerRecipes/"+c.getChainId();return c.httpGetOrPostWithCache(u.mealPlanners,a)},t.getAdPods=function(){var a=c.getStoreUrl()+"/ListSlots/"+c.getChainId();return c.httpGetOrPostWithCache(u.adPods,a)},t.getStoreList=function(){return null===c.isNull(u.storeList,null)&&(u.storeList=v.storeList),u.storeList},t.hasCompleteCircular=function(){var a=t.getCircularData(),b=!1;return a&&(u.storeId=a.StoreId,b=c.isNull(a.Circulars,!1)),!b&&c.isNull(c.getSelectedStoreId(),0)>0&&t.refreshCircular(),b},t.getCircularData=function(){return null===c.isNull(u.circular,null)&&(u.circular=v.circular),u.circular},t.initialize=function(a){c.getUseLocalStorage()&&(v=h),c.initApp(),t.getStores(),t.hasCompleteCircular()&&f(function(){o()},0),null!==c.isNull(a,null)&&(t.getAdPods(),t.getManufacturerCouponTotalSavings())},a.$on("gsnevent:store-setid",function(a,b){var d=b.newValue,e=c.isNull(u.storeId,0)!=d;e&&(u.storeId=d,u.circularIsLoading=!1);var f=(new Date).getTime(),g=(f-c.isNull(v.circularLastUpdate,0))/1e3;(e&&!u.circularIsLoading||g>120)&&t.refreshCircular()}),t}var c="gsnStore";a.module("gsn.core").service(c,["$rootScope","$http","gsnApi","$q","$window","$timeout","$sessionStorage","$localStorage","$location",b])}(angular),function(a){"use strict";function b(a,b,c,d,e,f){function g(){return{youtechCouponUrl:b.isNull(b.getYoutechCouponUrl(),""),cardCouponResponse:null,availableCouponById:{},takenCouponById:{},redeemedCouponById:{},isValidResponse:!1,currentProfile:{}}}function h(){return b.isNull(t.currentProfile.ExternalId,"").length>0}function i(){return h()&&b.isNaN(parseFloat(t.currentProfile.ExternalId),0)<48203769258}function j(){return h()&&t.isValidResponse}function k(a){return l(a)||m(a)}function l(a){return null!==b.isNull(t.availableCouponById[a],null)}function m(a){return null!==b.isNull(t.takenCouponById[a],null)}function n(a){return null!==b.isNull(t.redeemedCouponById[a],null)}function o(b,c,d,e){c.resolve({success:!1,response:e}),a.$broadcast(b,d)}function p(c){var d=e.defer();return b.getAccessToken().then(function(){var e=t.youtechCouponUrl+"/AddToCard/"+b.getProfileId()+"/"+c;f.post(e,{},{headers:b.getApiHeaders()}).success(function(b){t.takenCouponById[c]=!0,delete t.availableCouponById[c],d.resolve({success:!0,response:b}),a.$broadcast("gsnevent:youtech-cardcoupon-added",c)}).error(function(a){o("gsnevent:youtech-cardcoupon-addfail",d,c,a)})}),d.promise}function q(c){var d=e.defer();return b.getAccessToken().then(function(){var e=t.youtechCouponUrl+"/RemoveFromCard/"+b.getProfileId()+"/"+c;f.post(e,{},{headers:b.getApiHeaders()}).success(function(b){b.Success?(t.availableCouponById[c]=!0,delete t.takenCouponById[c],d.resolve({success:!0,response:b}),a.$broadcast("gsnevent:youtech-cardcoupon-removed",c)):o("gsnevent:youtech-cardcoupon-removefail",d,c,b.Message)}).error(function(a){o("gsnevent:youtech-cardcoupon-removefail",d,c,a)})}),d.promise}function r(){b.getAccessToken().then(function(){var c=t.youtechCouponUrl+"/GetProfileCoupons/"+b.getProfileId();f.get(c,{headers:b.getApiHeaders()}).success(function(c){if(c.Success){var d=0;t.isValidResponse=!0;try{if(t.cardCouponResponse=c.Response,t.cardCouponResponse.availableCoupons&&(t.availableCouponById=b.mapObject(t.cardCouponResponse.availableCoupons.coupon,"couponId")),t.cardCouponResponse.available_ids)for(t.availableCouponById={},d=0;d<t.cardCouponResponse.available_ids.length;d++)t.availableCouponById[t.cardCouponResponse.available_ids[d]]=!0;t.cardCouponResponse.takenCoupons&&(t.takenCouponById=b.mapObject(t.cardCouponResponse.takenCoupons.coupon,"couponId"));var e=b.isNull(t.cardCouponResponse.taken_ids,t.cardCouponResponse.clipped_active_ids);if(e)for(t.takenCouponById={},d=0;d<e.length;d++)t.takenCouponById[e[d]]=!0;if(e=t.cardCouponResponse.clipped_redeemed_ids)for(t.redeemedCouponById={},d=0;d<e.length;d++)t.takenCouponById[e[d]]=!0,t.redeemedCouponById[e[d]]=!0}catch(f){}return void a.$broadcast("gsnevent:youtech-cardcoupon-loaded",s)}t.isValidResponse=!1,a.$broadcast("gsnevent:youtech-cardcoupon-loadfail",s)}).error(function(){t.isValidResponse=!1,a.$broadcast("gsnevent:youtech-cardcoupon-loadfail",s)})})}var s={isValidCoupon:k,hasValidCard:j,addCouponTocard:p,removeCouponFromCard:q,isOldRoundyCard:i,isAvailable:l,isOnCard:m,hasRedeemed:n,hasCard:h,enable:!0},t=g();return a.$on("gsnevent:logout",function(){s.enable&&(t=g())}),a.$on("gsnevent:profile-load-success",function(a,b){s.enable&&(g(),t.youtechCouponUrl.length>2&&(t.currentProfile=b.response,r()))}),a.$on("gsnevent:store-persisted",function(){s.enable&&(g(),t.currentProfile&&t.youtechCouponUrl.length>2&&r())}),s}var c="gsnYoutech";a.module("gsn.core").service(c,["$rootScope","gsnApi","gsnProfile","gsnStore","$q","$http",b])}(angular);